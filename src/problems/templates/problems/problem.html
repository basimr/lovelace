{% extends "base.html" %}
{% load widget_tweaks %}

{% block preload_javascript %}
<!-- MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<!-- Ace editor config -->
<style type="text/css" media="screen">
  #editor {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    width: 95%;
    height: 100%;
  }
</style>

<!-- CSS to show active tab and hide inactive tabs. -->
<style>
  #tab-content section {
    display: none;
  }

  #tab-content section.is-active {
    display: block;
  }
</style>
{% endblock %}

{% block page_title %}
  {{ problem.title }} | Project Lovelace
{% endblock %}

{% block body %}
<meta name="problem_name" content="problem.name">
<section class="section">
  <br>
  <h1 class="title is-2 has-text-centered">{{ problem.title }}</h1>
  <h3 class="subtitle is-5 has-text-centered is-italic"><strong>Useful to know</strong>: {% block required %}{% endblock %}</h3>

  <div id="tabs" class="tabs is-centered is-boxed">
    <ul>
      <li data-tab="1" class="is-active">
        <a>
          <span class="icon is-small"><i class="fas fa-align-justify" aria-hidden="true"></i></span>
          <span>Description</span>
        </a>
      </li>
      <li data-tab="2">
        <a>
          <span class="icon is-small"><i class="fas fa-history" aria-hidden="true"></i></span>
          <span>Submissions</span>
        </a>
      </li>
      <li data-tab="3">
        <a>
          <span class="icon is-small"><i class="fas fa-book" aria-hidden="true"></i></span>
          <span>Notes and references</span>
        </a>
      </li>
      <li data-tab="4">
        <a>
          <span class="icon is-small"><i class="far fa-comments" aria-hidden="true"></i></span>
          <span>Forum</span>
        </a>
      </li>
      <li data-tab="5">
        <a>
          <span class="icon is-small"><i class="fas fa-check-double" aria-hidden="true"></i></span>
          <span>Solution</span>
        </a>
      </li>
    </ul>
  </div>

  <div class="container" id="tab-content">
    <section data-content="1" class="is-active"> <!-- Description tab -->
      <p class="has-text-justified">
        {% block introduction %}{% endblock %}
        {% block problem_body %}{% endblock %}
      </p>
      <br>
      
      <p><strong>Input</strong>: {% block input_description %}{% endblock %}</p>
      <br>
      <p><strong>Output</strong>: {% block output_description %}{% endblock %}</p>
      <br>
      
      <article class="message">
        <div class="message-header">
          <p>Example input</p>
        </div>
        <div class="message-body" style="font-family: monospace; text-align: justify">
          {% block input_example %}{% endblock %}
        </div>
      </article>

      <article class="message">
        <div class="message-header">
          <p>Example output</p>
        </div>
        <div class="message-body" style="font-family: monospace; text-align: justify">
          {% block output_example %}{% endblock %}
        </div>
      </article>
    </section>

    <section data-content="2"> <!-- Submissions tab -->
      {% if previous_submissions %}
        <div class="columns is-centered">
          <table class="table is-hoverable">
            <thead>
              <tr>
                <th><abbr title="Submission ID">#</abbr></th>
                <th>Date</th>
                <th>File</th>
                <th title="Sum of runtimes of all test cases">Runtime</th>
                <th title="Maximum memory usage among all test cases">Memory</th>
                <th>Language</th>
                <th>Passed</th>
              </tr>
            </thead>
            {% for sub in previous_submissions %}
              <tbody>
                <tr>
                  <td>{{ sub.id }}</td>
                  <td>{{ sub.date }}</td>
                  <td><a href="{{ sub.file.url }}">{{ sub.filename }}</a> ({{ sub.file.size }} bytes)</td>
                  <td>{{ sub.runtime_sum }}</td>
                  <td>{{ sub.max_mem_usage }}</td>
                  <td>{{ sub.language }}</td>
                  {% if sub.test_cases_passed == 0 %}
                    <td class="has-text-danger">{{ sub.test_cases_passed }}/{{ sub.test_cases_total }}</td>
                  {% elif sub.test_cases_passed == sub.test_cases_total %}
                    <td class="has-text-success">{{ sub.test_cases_passed }}/{{ sub.test_cases_total }}</td>
                  {% else %}
                    <td class="has-text-warning">{{ sub.test_cases_passed }}/{{ sub.test_cases_total }}</td>
                  {% endif %}
                </tr>
              </tbody>
            {% endfor %}
          </table>
        </div>
      {% endif %}

      <p>You can use the editor below or upload a file to submit your code.</p><br>
      <div class="columns is-centered">
        <div class="column is-three-quarters" style="position: relative;">
          <div id="editor">def earthquake_epicenter_2d(x1, y1, t1, x2, y2, t2, x3, y3, t3):
            pass
            return (x0, y0)'
          </div>
          <a class="button is-primary">Submit code</a>
        </div>

        <div class="is-divider-vertical" data-content="OR"></div>
          <div class="column is-one-quarter">
            <div class="container">
              {% if user.is_authenticated %}
                <div class="file has-name is-boxed">
                  <form method="post" id="code-submit-form" enctype="multipart/form-data">
                    {% csrf_token %}
                    <label class="file-label">
                      {% render_field form.file class+="file-input" %}
                      <span class="file-cta">
                        <span class="file-icon"><i class="fas fa-upload"></i></span>
                        <span class="file-label">Choose file...</span>
                      </span>
                      <span class="file-name" id="file-name-span"></span>
                    </label>
                    <br>
                    <div class="control has-text-centered">
                      <button class="button is-primary" type="submit" id="submit-code-button">Submit file</button>
                    </div>
                  </form>
                </div>
              {% else %}
                <p>You must be logged in to submit code.</p>
              {% endif %}
            </div>
          </div>
      </div>
    </section>

    <section data-content="3"> <!-- Notes and references tab -->
      <p>Notes and references go here...</p>
    </section>

    <section data-content="4"> <!-- Forum tab -->
      <p>Discussion goes here!</p>
    </section>

    <section data-content="5"> <!-- Forum tab -->
      <p>I wonder if you can see the text below...</p><br>
      <div>
        <p>Solution goes here!</p>
      </div>
    </section>

  </div>

  <!-- Modal for showing test case results -->
  <div class="modal" id="results-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title" id="results-modal-title"></p>
        <button class="delete" aria-label="close" id="modal-close"></button>
      </header>
      <section class="modal-card-body" id="results-modal-body"></section>
      <footer class="modal-card-foot">
        <button class="button is-success">Save changes</button>
        <button class="button">Close</button>
      </footer>
    </div>
  </div>

</section>
{% endblock %}

{% block postload_javascript %}
<!-- Ace Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.1/ace.js" type="text/javascript" charset="utf-8"></script>

<script>
  var editor = ace.edit("editor");
  editor.setTheme("ace/theme/eclipse");
  editor.session.setMode("ace/mode/python");
  editor.resize();
</script>

<script>
  document.getElementById('{{ form.file.auto_id }}').onchange = function() {
      // See: https://stackoverflow.com/a/9234894
      var filename = this.value.split(/(\\|\/)/g).pop();
      document.getElementById('file-name-span').innerHTML = filename;
  };
</script>

<script>
  // Tab switching.
  // Credit to sol @ https://stackoverflow.com/a/47591788
  const TABS = [...document.querySelectorAll('#tabs li')];
  const CONTENT = [...document.querySelectorAll('#tab-content section')];
  const ACTIVE_CLASS = 'is-active';

  function initTabs() {
    TABS.forEach((tab) => {
      tab.addEventListener('click', (e) => {
        let selected = tab.getAttribute('data-tab');
        updateActiveTab(tab);
        updateActiveContent(selected);
      })
    })
  }

  function updateActiveTab(selected) {
    TABS.forEach((tab) => {
      if (tab && tab.classList.contains(ACTIVE_CLASS)) {
        tab.classList.remove(ACTIVE_CLASS);
      }
    });
    selected.classList.add(ACTIVE_CLASS);
  }

  function updateActiveContent(selected) {
    CONTENT.forEach((item) => {
      if (item && item.classList.contains(ACTIVE_CLASS)) {
        item.classList.remove(ACTIVE_CLASS);
      }
      let data = item.getAttribute('data-content');
      if (data === selected) {
        item.classList.add(ACTIVE_CLASS);
      }
    });
  }

  initTabs();
</script>

<script>
    var modal = document.getElementById('modal-close');
    modal.addEventListener('click', function(event) {
      event.stopPropagation();
      document.getElementById('results-modal').classList.toggle('is-active');
    });

  var apiUrl = '{% url 'problems:detail' problem.name %}';
  var csrf_token = '{{ csrf_token }}';

  function sendCodeFile(event) {
    console.log("Inside sendCodeFile()...");
    
    var form = document.forms.namedItem('code-submit-form');
    var data = new FormData(form);

    var xhr = new XMLHttpRequest();
    xhr.open('POST', apiUrl, true);
    // xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    xhr.setRequestHeader('X-CSRFToken', csrf_token);
    xhr.onload = injectTestCaseResults;
    xhr.onerror = handleAjaxError;
    xhr.send(data);
  }

  document.getElementById('code-submit-form').addEventListener('submit',
    function(event) {
      document.getElementById('submit-code-button').classList.add('is-loading');
      
      event.preventDefault()
      event.stopImmediatePropagation();
      sendCodeFile(event);

      // Prevents the default action and stops propagation.
      // See: http://blog.niftysnippets.org/2011/11/story-on-return-false.html
      return false;
  });

  function injectTestCaseResults() {
    console.log("Inside injectTestCaseResults()...")
    r = JSON.parse(this.response).results;

    if (r.success) {
      document.getElementById('results-modal-title').innerHTML += "Success!";
    } else {
      document.getElementById('results-modal-title').innerHTML += "Failed.";
    }

    var nTestCases = r.testCaseDetails.length;
    var passes = 0;
    for (var i = 0; i < nTestCases; i++) {
        passes += r.testCaseDetails[i].passed ? 1 : 0;
    }

    document.getElementById('results-modal-title').innerHTML
        += ' Passed ' + passes + '/' + nTestCases + ' test cases.';

    // Print all the test case details.
    var resultsModalBody = document.getElementById('results-modal-body');
    resultsModalBody.innerHTML = '';

    for (var i = 0; i < nTestCases; i++) {
      testCasePanelTitle = 'Test case ' + (i+1) + '/' + nTestCases
          + ' (' + r.testCaseDetails[i].testCaseType + '): ';

      if (r.testCaseDetails[i].passed) {
          testCasePanelTitle += 'passed!<br>';
      } else {
          testCasePanelTitle += 'failed.<br>';
      }

      processInfoString = 'Return code ' + r.testCaseDetails[i].processInfo.returnCode + ', '
          + 'utime: ' + r.testCaseDetails[i].processInfo.utime + ' s, '
          + 'stime: ' + r.testCaseDetails[i].processInfo.stime + ' s, '
          + 'maxrss: ' + r.testCaseDetails[i].processInfo.maxrss + ' kB.<br><br>';

      resultsModalBody.innerHTML += '<article class="message">'
          + '<div class="message-header">'
          + '<p>' + testCasePanelTitle + '</p></div>'
          + '<div class="message-body" style="font-family: monospace; text-align: justify">'
          + processInfoString
          + 'Input:<br>' + r.testCaseDetails[i].inputString + '<br><br>'
          + 'Output:<br>' + r.testCaseDetails[i].outputString
          + '</div></article>';
    }

    document.getElementById('submit-code-button').classList.remove('is-loading');
    document.getElementById('results-modal').classList.add('is-active');
    console.log("Done drawing modal.");
  }

  function handleAjaxError() {
    console.log("AJAX error!");
    console.log(this.response);
  }
</script>

{% endblock %}
